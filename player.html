<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>HLS Fullscreen Player</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.css">

<style>
  html,body{
    margin:0;
    padding:0;
    background:#000;
    height:100%;
    overflow:hidden;
  }
  #dplayer{
    position:fixed;
    inset:0;
    width:100vw;
    height:100vh;
  }
</style>
</head>
<body>
<div id="dplayer"></div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.js"></script>
<script>
function getSrc(){
  const url = new URL(location.href);
  let src = url.searchParams.get("url") || "";
  if(!src) return "";
  try { src = decodeURIComponent(src); } catch(e){}
  if(!/^https?:\/\//i.test(src)) src = "https://" + src.replace(/^\/+/, '');
  return src;
}

const src = getSrc();
if(!src){
  document.body.innerHTML = "<center style='color:#fff;padding-top:40px;'>请使用 index.html?url=你的m3u8</center>";
}else{
  const dp = new DPlayer({
    container: document.getElementById('dplayer'),
    video: { url: src, type: 'hls' },
    autoplay: true,
    screenshot: false,
    preload: 'auto',
    mutex: true
  });

  dp.on('loadedmetadata', ()=>{
    dp.video.setAttribute('playsinline','');
    dp.video.setAttribute('webkit-playsinline','');
    dp.video.muted = true;  // **强制静音以确保自动播放**
    dp.play().catch(()=>{});
  });

  // **方案 A：防 403 禁止发送 Referer**
  const hls = dp.video.hls;
  if(hls){
    hls.config.fetchSetup = (context, init) => {
      return Object.assign(init || {}, {
        referrerPolicy: 'no-referrer' // ← 禁止发送 referer，解决 GitHub Pages 403
      });
    };
  }
}
</script>
</body>
</html>
